import pytest
from clue.common.exceptions import (ClueException, InvalidDataException,
                                    NotFoundException, TimeoutException,
                                    UnprocessableException)
from clue.models.network import QueryEntry
from clue.plugin.utils import Params
from flask import Flask
from malware_bazaar.app import enrich


@pytest.fixture(scope="module")
def test_app():
    app = Flask("test")

    return app


def test_enrich(test_app: Flask):
    with test_app.test_request_context():
        params = Params.from_request()

        try:
            result = enrich("sha256", "fecffd8f6cdd8ad950507bebbb23a146ec5252e35be146840ded98dff189cf12", params)

            assert isinstance(result, list)
            assert isinstance(result[0], QueryEntry)
        except (TimeoutException, ClueException):
            pytest.skip("Malware Bazaar is not accessible")

        with pytest.raises(NotFoundException):
            try:
                enrich("sha256", "a" * 64, params)
            except (TimeoutException, ClueException):
                pytest.skip("Malware Bazaar is not accessible")

        with pytest.raises(UnprocessableException):
            try:
                enrich("sha256", "a" * 62, params)
            except (TimeoutException, ClueException):
                pytest.skip("Malware Bazaar is not accessible")

        with pytest.raises(InvalidDataException):
            try:
                enrich("sha254", "a" * 62, params)
            except (TimeoutException, ClueException):
                pytest.skip("Malware Bazaar is not accessible")

        params.max_timeout = 0.001

        with pytest.raises(TimeoutException):
            enrich("sha256", "fecffd8f6cdd8ad950507bebbb23a146ec5252e35be146840ded98dff189cf12", params)
