name: Lint and Format Plugin

on:
  workflow_call:
    inputs:
      plugin-path:
        required: true
        type: string

jobs:
  lint-and-format:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Ruff
        run: pip install ruff mypy

      - name: Run Ruff format
        run: ruff format ${{ inputs.plugin-path }} --diff

      - name: Run Ruff lint
        run: ruff check ${{ inputs.plugin-path }} --output-format=github

      - name: Run Mypy
        run: mypy ${{ inputs.plugin-path }}

      - name: Install yq
        run: sudo snap install yq

      - name: Check for manifest file with correct properties
        run: |
          echo "Validating manifest.yml"

          # Check if manifest.yml exists
          if [ ! -f "${{ inputs.plugin-path }}/manifest.yml" ]; then
            echo "‚ùå Error: manifest.yml not found in ${{ inputs.plugin-path }}"
            exit 1
          fi

          echo "‚úÖ manifest.yml found"

          # Check required keys
          MANIFEST_FILE="${{ inputs.plugin-path }}/manifest.yml"

          # Check if 'name' key exists and is not empty
          NAME=$(yq '.name' "$MANIFEST_FILE")
          if [ "$NAME" = "null" ] || [ -z "$NAME" ]; then
            echo "‚ùå Error: 'name' key is missing or empty in manifest.yml"
            exit 1
          fi
          echo "‚úÖ 'name' key found: $NAME"

          # Check if 'base-plugin-tag' key exists and is not empty
          BASE_TAG=$(yq '.base-plugin-tag' "$MANIFEST_FILE")
          if [ "$BASE_TAG" = "null" ] || [ -z "$BASE_TAG" ]; then
            echo "‚ùå Error: 'base-plugin-tag' key is missing or empty in manifest.yml"
            exit 1
          fi
          echo "‚úÖ 'base-plugin-tag' key found: $BASE_TAG"

          # Check if 'version' key exists and is not empty
          VERSION=$(yq '.version' "$MANIFEST_FILE")
          if [ "$VERSION" = "null" ] || [ -z "$VERSION" ]; then
            echo "‚ùå Error: 'version' key is missing or empty in manifest.yml"
            exit 1
          fi
          echo "‚úÖ 'version' key found: $VERSION"

          echo "üéâ All required keys are present in manifest.yml"
